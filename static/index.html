<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>proChess - Online</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0-beta.6/chess.min.js"></script>
    <style>
        body { font-family: Arial; background: #f0d9b5; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; display: flex; gap: 30px; }
        #board-container { flex: 1; max-width: 600px; }
        #board { width: 100%; height: auto; aspect-ratio: 1; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border-radius: 12px; }
        #moves-panel { flex: 0 0 350px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); height: fit-content; }
        #moves-list { list-style: none; padding: 0; margin: 0; font-family: monospace; font-size: 16px; max-height: 500px; overflow-y: auto; }
        #moves-list li { padding: 4px 0; }
        .white-move { color: #0066cc; font-weight: bold; }
        .black-move { color: #cc0000; font-weight: bold; }
        #status { text-align: center; font-size: 24px; margin: 20px 0; color: #333; }
        button { padding: 12px 24px; font-size: 18px; margin: 10px; border: none; border-radius: 8px; background: #4CAF50; color: white; cursor: pointer; }
        button:hover { background: #45a049; }
        #joinSection { text-align: center; margin-top: 20px; }
        #gameId { padding: 12px; font-size: 16px; width: 200px; margin-right: 10px; border-radius: 6px; border: 1px solid #ddd; }
        h2 { margin-top: 0; color: #333; }
        @media (max-width: 1000px) { .container { flex-direction: column; } #moves-panel { order: 2; } }
    </style>
</head>
<body>
    <h1 style="text-align: center;">♟️ proChess Online ♟️</h1>
    
    <div id="status">¡Crea o únete a una partida!</div>
    
    <div class="container">
        <div id="board-container">
            <div id="board"></div>
        </div>
        
        <div id="moves-panel">
            <h2>Jugadas</h2>
            <ol id="moves-list" reversed></ol>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
        <button id="create">Crear Partida (Blancas)</button>
        <div id="joinSection" style="display: none;">
            <input id="gameId" placeholder="ID de partida">
            <br>
            <button id="joinWhite">Unirse Blancas</button>
            <button id="joinBlack">Unirse Negras</button>
        </div>
    </div>

    <script>
// 1. Primero definimos las variables globales necesarias
let ws = null;
let myColor = null;
let gameId = null;

// 2. Creamos la instancia de Chess ANTES de usar 'game' en cualquier función
const game = new Chess();

// 3. Definimos onDrop (ahora 'game' ya existe)
function onDrop(source, target) {
    console.log('onDrop llamado → source:', source, 'target:', target);

    // Verificar si es tu turno
    const myTurn = (myColor === 'white' && game.turn() === 'w') ||
                   (myColor === 'black' && game.turn() === 'b');
    
    if (!myTurn) {
        console.log('No es tu turno');
        return 'snapback';
    }

    try {
        const move = game.move({
            from: source,
            to: target,
            promotion: 'q'  // dama automática
        });

        if (move === null) {
            console.log('Movimiento ilegal');
            return 'snapback';
        }

        const uci = source + target + (move.promotion || '');
        console.log('Movimiento válido, UCI:', uci);

        // Enviar al servidor
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'move', uci: uci }));
        } else {
            console.warn('WS no conectado');
        }

        // Actualizar tablero y lista de jugadas
        board.position(game.fen());
        addMove(move.san);

        return null;  // Aceptar el drop → la pieza se suelta
    } catch (error) {
        console.error('Error en onDrop:', error);
        return 'snapback';
    }
}

// 4. Función addMove (si no la tienes, agrégala aquí)
function addMove(san) {
    const list = document.getElementById('moves-list');
    const li = document.createElement('li');
    li.textContent = san;
    
    // Color según quién movió
    if (game.turn() === 'b') {
        li.className = 'white-move';
    } else {
        li.className = 'black-move';
    }
    
    list.appendChild(li);
    li.scrollIntoView({ behavior: 'smooth' });
}

// 5. Ahora creamos el tablero (después de definir onDrop)
const board = Chessboard('board', {
    draggable: true,
    pieceTheme: '/img/pieces/{piece}.png',
    position: 'start',
    onDrop: onDrop   // ← ahora está definido
});

// 6. Resto de tu código (create, join, connectWS, etc.)
// ... (pega aquí el resto de tu script: create, join, connectWS, etc.)
</script>
</body>
</html>



