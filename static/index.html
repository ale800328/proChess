<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>proChess - Online</title>

    <!-- CSS chessboard -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <!-- jQuery primero -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- chessboard.js -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <!-- chess.js al final -->
    <script src="https://cdn.jsdelivr.net/npm/chess.js@0.12.0/chess.min.js"></script>

    <style>
        body { font-family: Arial; background: #f0d9b5; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; display: flex; gap: 30px; flex-wrap: wrap; }
        #board-container { flex: 1; min-width: 400px; max-width: 600px; }
        #board { width: 100%; height: auto; aspect-ratio: 1; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border-radius: 12px; }
        #moves-panel { flex: 0 0 350px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); height: fit-content; }
        #moves-list { list-style: none; padding: 0; margin: 0; font-family: monospace; font-size: 16px; max-height: 500px; overflow-y: auto; }
        #moves-list li { padding: 4px 0; }
        .white-move { color: #0066cc; font-weight: bold; }
        .black-move { color: #cc0000; font-weight: bold; }
        #status { text-align: center; font-size: 24px; margin: 20px 0; color: #333; }
        button { padding: 12px 24px; font-size: 18px; margin: 10px; border: none; border-radius: 8px; background: #4CAF50; color: white; cursor: pointer; }
        button:hover { background: #45a049; }
        #joinSection { text-align: center; margin-top: 20px; }
        #gameId { padding: 12px; font-size: 16px; width: 200px; margin: 10px; border-radius: 6px; border: 1px solid #ddd; }
        h2 { margin-top: 0; color: #333; }
    </style>
</head>
<body>
    <h1 style="text-align: center;">♟️ proChess Online ♟️</h1>

    <div id="status">¡Crea o únete a una partida!</div>

    <div class="container">
        <div id="board-container">
            <div id="board"></div>
        </div>

        <div id="moves-panel">
            <h2>Jugadas</h2>
            <ol id="moves-list" reversed></ol>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button id="create">Crear Partida (Blancas)</button>
        <div id="joinSection" style="display: none;">
            <input id="gameId" placeholder="ID de partida">
            <br>
            <button id="joinWhite">Unirse Blancas</button>
            <button id="joinBlack">Unirse Negras</button>
        </div>
    </div>

    <script>
    // Esperamos a que el DOM esté listo (más rápido y confiable que onload para scripts)
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOMContentLoaded: DOM listo');

        // Verificamos que Chess esté definido (por si el script de chess.js se retrasó)
        if (typeof Chess === 'undefined') {
            console.error('Chess.js no cargó a tiempo');
            document.getElementById('status').textContent = 'Error: librería de ajedrez no cargó. Refresca la página.';
            return;
        }

        // Crear instancia de Chess
        const game = new Chess();

        // Configuración del tablero
        const board = Chessboard('board', {
    draggable: true,
    pieceTheme: '/img/pieces/{piece}.png',
    position: 'start',
    onDrop: function (source, target) {
        console.log('onDrop ejecutado:', source, '→', target);

        // Temporal: permitir mover siempre para probar si suelta la pieza
        // Descomenta la validación cuando el join funcione
        // if ((myColor === 'white' && game.turn() !== 'w') ||
        //     (myColor === 'black' && game.turn() !== 'b')) {
        //     console.log('No es tu turno');
        //     return 'snapback';
        // }

        const move = game.move({
            from: source,
            to: target,
            promotion: 'q'
        });

        if (move === null) {
            console.log('Movimiento ilegal → snapback');
            return 'snapback';
        }

        const uci = source + target + (move.promotion || '');
        console.log('Movimiento válido:', uci);

        // Enviar al servidor
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'move', uci: uci }));
        } else {
            console.warn('WebSocket no está abierto');
        }

        // Agregar a la lista de jugadas
        addMove(move.san);

        // NO actualizar posición local aquí (ya lo hace el servidor)
        // board.position(game.fen());  ← ya lo quitaste, perfecto

        return null;  // Aceptar el drop → pieza se suelta
    }
});

        console.log('Tablero inicializado OK');

        // Tus variables y funciones restantes (ws, myColor, create, join, addMove...)
        let ws = null;
        let myColor = null;

        // ... pega aquí el resto de tu código (create onclick, joinGame, connectWS, addMove, etc.)
        // Por ejemplo:
        document.getElementById('create').onclick = async () => {
            // tu código de crear partida
        };

        // etc.
    });
</script>
</body>
</html>





