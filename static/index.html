<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>proChess - Online</title>

    <!-- CSS chessboard -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <!-- jQuery primero -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- chessboard.js -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <!-- chess.js al final -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0-beta.6/chess.min.js"></script>

    <style>
        body { font-family: Arial; background: #f0d9b5; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; display: flex; gap: 30px; flex-wrap: wrap; }
        #board-container { flex: 1; min-width: 400px; max-width: 600px; }
        #board { width: 100%; height: auto; aspect-ratio: 1; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border-radius: 12px; }
        #moves-panel { flex: 0 0 350px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); height: fit-content; }
        #moves-list { list-style: none; padding: 0; margin: 0; font-family: monospace; font-size: 16px; max-height: 500px; overflow-y: auto; }
        #moves-list li { padding: 4px 0; }
        .white-move { color: #0066cc; font-weight: bold; }
        .black-move { color: #cc0000; font-weight: bold; }
        #status { text-align: center; font-size: 24px; margin: 20px 0; color: #333; }
        button { padding: 12px 24px; font-size: 18px; margin: 10px; border: none; border-radius: 8px; background: #4CAF50; color: white; cursor: pointer; }
        button:hover { background: #45a049; }
        #joinSection { text-align: center; margin-top: 20px; }
        #gameId { padding: 12px; font-size: 16px; width: 200px; margin: 10px; border-radius: 6px; border: 1px solid #ddd; }
        h2 { margin-top: 0; color: #333; }
    </style>
</head>
<body>
    <h1 style="text-align: center;">♟️ proChess Online ♟️</h1>

    <div id="status">¡Crea o únete a una partida!</div>

    <div class="container">
        <div id="board-container">
            <div id="board"></div>
        </div>

        <div id="moves-panel">
            <h2>Jugadas</h2>
            <ol id="moves-list" reversed></ol>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button id="create">Crear Partida (Blancas)</button>
        <div id="joinSection" style="display: none;">
            <input id="gameId" placeholder="ID de partida">
            <br>
            <button id="joinWhite">Unirse Blancas</button>
            <button id="joinBlack">Unirse Negras</button>
        </div>
    </div>

    <script>
        // Esperamos a que TODAS las librerías y el DOM estén listos
        window.onload = function () {
            console.log('window.onload: todas las librerías cargadas');

            // Crear instancia de Chess
            const game = new Chess();

            // Configuración del tablero
            const board = Chessboard('board', {
                draggable: true,
                pieceTheme: '/img/pieces/{piece}.png',
                position: 'start',
                onDrop: (source, target) => {
                    console.log('onDrop llamado:', source, '→', target);

                    if ((myColor === 'white' && game.turn() !== 'w') ||
                        (myColor === 'black' && game.turn() !== 'b')) {
                        console.log('No es tu turno');
                        return 'snapback';
                    }

                    const move = game.move({
                        from: source,
                        to: target,
                        promotion: 'q'
                    });

                    if (move === null) {
                        console.log('Movimiento ilegal');
                        return 'snapback';
                    }

                    const uci = source + target + (move.promotion || '');
                    console.log('Movimiento válido:', uci);

                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'move', uci }));
                    }

                    board.position(game.fen());
                    addMove(move.san);

                    return null;
                }
            });

            console.log('Tablero inicializado correctamente');

            // Resto de tu código (variables, funciones, eventos)
            let ws = null;
            let myColor = null;

            document.getElementById('create').onclick = async () => {
                try {
                    const res = await fetch('/create_game');
                    const data = await res.json();
                    const gameId = data.game_id;
                    connectWS(gameId);
                    myColor = 'white';
                    document.getElementById('status').textContent = `Partida creada: ${gameId}`;
                    document.getElementById('joinSection').style.display = 'block';
                    document.getElementById('gameId').value = gameId;
                } catch (err) {
                    alert('Error al crear');
                }
            };

            document.getElementById('joinWhite').onclick = () => joinGame('white');
            document.getElementById('joinBlack').onclick = () => joinGame('black');

            function joinGame(color) {
                const gameId = document.getElementById('gameId').value.trim();
                if (!gameId) return alert('ID requerido');
                connectWS(gameId);
                myColor = color;
                document.getElementById('status').textContent = `Unido como ${color}`;
            }

            function connectWS(id) {
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${location.host}/ws/${id}`);

                ws.onopen = () => {
                    ws.send(JSON.stringify({ type: 'join', color: myColor }));
                };

                ws.onmessage = (e) => {
                    const msg = JSON.parse(e.data);
                    if (msg.type === 'move') {
                        game.move(msg.uci, { sloppy: true });
                        board.position(msg.fen);
                        addMove(msg.san || msg.uci);
                    }
                };
            }

            function addMove(san) {
                const li = document.createElement('li');
                li.textContent = san;
                li.className = game.turn() === 'b' ? 'white-move' : 'black-move';
                document.getElementById('moves-list').appendChild(li);
                li.scrollIntoView();
            }
        };
    </script>
</body>
</html>
